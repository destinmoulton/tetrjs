var BLOCK_TYPES=["STRAIGHT","L_LEFT","L_RIGHT","SQUARE","S","Z","T"],BLOCKS={};BLOCKS.STRAIGHT={class:"tetrjs-block-straight",no_positions:2,positions:{0:{trans_row:1,trans_col:-1,rows:{0:{0:1,1:1,2:1,3:1}}},1:{trans_row:-1,trans_col:1,rows:{0:{0:1},1:{0:1},2:{0:1},3:{0:1}}}}},BLOCKS.L_LEFT={class:"tetrjs-block-l-left",no_positions:4,positions:{0:{trans_row:1,trans_col:-1,rows:{0:{0:1,1:1,2:1},1:{0:0,1:0,2:1}}},1:{trans_row:-1,trans_col:0,rows:{0:{0:0,1:1},1:{0:0,1:1},2:{0:1,1:1}}},2:{trans_row:0,trans_col:0,rows:{0:{0:1,1:0,2:0},1:{0:1,1:1,2:1}}},3:{trans_row:0,trans_col:1,rows:{0:{0:1,1:1},1:{0:1,1:0},2:{0:1,1:0}}}}},BLOCKS.L_RIGHT={class:"tetrjs-block-l-right",no_positions:4,positions:{0:{trans_row:1,trans_col:-1,rows:{0:{0:1,1:1,2:1},1:{0:1,1:0,2:0}}},1:{trans_row:-1,trans_col:0,rows:{0:{0:1,1:1},1:{0:0,1:1},2:{0:0,1:1}}},2:{trans_row:0,trans_col:0,rows:{0:{0:0,1:0,2:1},1:{0:1,1:1,2:1}}},3:{trans_row:0,trans_col:1,rows:{0:{0:1,1:0},1:{0:1,1:0},2:{0:1,1:1}}}}},BLOCKS.SQUARE={class:"tetrjs-block-square",no_positions:1,positions:{0:{trans_row:0,trans_col:0,rows:{0:{0:1,1:1},1:{0:1,1:1}}}}},BLOCKS.S={class:"tetrjs-block-s",no_positions:2,positions:{0:{trans_row:1,trans_col:0,rows:{0:{0:0,1:1,2:1},1:{0:1,1:1,2:0}}},1:{trans_row:-1,trans_col:0,rows:{0:{0:1,1:0},1:{0:1,1:1},2:{0:0,1:1}}}}},BLOCKS.Z={class:"tetrjs-block-z",no_positions:2,positions:{0:{trans_row:1,trans_col:0,rows:{0:{0:1,1:1,2:0},1:{0:0,1:1,2:1}}},1:{trans_row:-1,trans_col:0,rows:{0:{0:0,1:1},1:{0:1,1:1},2:{0:1,1:0}}}}},BLOCKS.T={class:"tetrjs-block-t",no_positions:4,positions:{0:{trans_row:1,trans_col:-1,rows:{0:{0:1,1:1,2:1},1:{0:0,1:1,2:0}}},1:{trans_row:-1,trans_col:0,rows:{0:{0:0,1:1},1:{0:1,1:1},2:{0:0,1:1}}},2:{trans_row:0,trans_col:0,rows:{0:{0:0,1:1,2:0},1:{0:1,1:1,2:1}}},3:{trans_row:0,trans_col:1,rows:{0:{0:1,1:0},1:{0:1,1:1},2:{0:1,1:0}}}}},this.templates=this.templates||{},this.templates.about=new Hogan.Template({code:function(t,e,s){var r=this;return r.b(s=s||""),r.b("Tetrjs is a Tetris clone written in JavaScript."),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b('Tetrjs was written by <a href="https://destinmoulton.com" target="_blank">Destin Moulton</a>.'),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b('Available on <a href="https://github.com/destinmoulton/tetrjs" target="_blank">GitHub</a>.'),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b('Open source under the <a href="https://en.wikipedia.org/wiki/MIT_License">MIT License</a>.'),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b('<button type="button"'),r.b("\n"+s),r.b('        id="tetrjs-about-close"'),r.b("\n"+s),r.b('        class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-remove"></span>&nbsp;Close</button>'),r.b("\n"),r.fl()},partials:{},subs:{}}),this.templates.container=new Hogan.Template({code:function(t,e,s){var r=this;return r.b(s=s||""),r.b("<!-- The Game Container -->"),r.b("\n"+s),r.b("<div id='tetrjs-container'>"),r.b("\n"+s),r.b("    <div id='tetrjs-title-container'>Tetrjs</div>"),r.b("\n"+s),r.b("    <div id='tetrjs-board'></div>"),r.b("\n"+s),r.b("    <div id='tetrjs-next-piece-preview-container'></div>"),r.b("\n"+s),r.b("    <div id='tetrjs-score-container'></div>"),r.b("\n"+s),r.b("    <div id='tetrjs-level-container'></div>"),r.b("\n"+s),r.b("    <div id='tetrjs-actions-container'>"),r.b("\n"+s),r.b("        <br/>"),r.b("\n"+s),r.b('        <button type="button"'),r.b("\n"+s),r.b('                id="tetrjs-container-pause"'),r.b("\n"+s),r.b('                class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-pause"></span>&nbsp;<b><u>P</u></b>ause</button>'),r.b("\n"+s),r.b("        <br/>"),r.b("\n"+s),r.b("        <br/>"),r.b("\n"+s),r.b('        <button type="button"'),r.b("\n"+s),r.b('                id="tetrjs-container-new"'),r.b("\n"+s),r.b('                class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-refresh"></span>&nbsp;&nbsp;New Game</button>'),r.b("\n"+s),r.b("        <br/>"),r.b("\n"+s),r.b("        <br/>"),r.b("\n"+s),r.b('        <button type="button"'),r.b("\n"+s),r.b('                id="tetrjs-container-about"'),r.b("\n"+s),r.b('                class="btn btn-primary btn-sm">About Tetrjs</button>'),r.b("\n"+s),r.b("    </div>"),r.b("\n"+s),r.b("    <div id='tetrjs-modal-veil'></div>"),r.b("\n"+s),r.b("    <div id='tetrjs-modal'></div>"),r.b("\n"+s),r.b("</div>"),r.fl()},partials:{},subs:{}}),this.templates.gameover=new Hogan.Template({code:function(t,e,s){var r=this;return r.b(s=s||""),r.b("Game Over!"),r.b("\n"+s),r.b("<br/><br/>"),r.b("\n"+s),r.b('<table border="0" id="tetrjs-gameover-table">'),r.b("\n"+s),r.b("    <tbody>"),r.b("\n"+s),r.b("    <tr><td><strong>Score:</strong></td><td>"),r.b(r.v(r.f("score",t,e,0))),r.b("</td></tr>"),r.b("\n"+s),r.b("    <tr><td><strong>Lines:</strong></td><td>"),r.b(r.v(r.f("rowsEliminated",t,e,0))),r.b("</td></tr>"),r.b("\n"+s),r.b("    <tr><td><strong>Level:</strong></td><td>"),r.b(r.v(r.f("level",t,e,0))),r.b("</td></tr>"),r.b("\n"+s),r.b("    </tbody>"),r.b("\n"+s),r.b("</table>"),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b('<button type="button"'),r.b("\n"+s),r.b('        id="tetrjs-gameover-newgame"'),r.b("\n"+s),r.b('        class="btn btn-primary btn-sm">New Game</button>'),r.fl()},partials:{},subs:{}}),this.templates.intro=new Hogan.Template({code:function(t,e,s){var r=this;return r.b(s=s||""),r.b('<button type="button"'),r.b("\n"+s),r.b('        id="tetrjs-intro-newgame"'),r.b("\n"+s),r.b('        class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-play"></span>&nbsp;&nbsp;Play Tetrjs!</button>'),r.b("\n"),r.b("\n"+s),r.b("<br/><br/>"),r.b("\n"+s),r.b("Arrow keys control the pieces."),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b("&nbsp;<span class='glyphicon glyphicon-arrow-up tetrjs-arrow-updown'></span>"),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b("<span class='glyphicon glyphicon-arrow-left tetrjs-arrow tetrjs-arrow-leftright'></span>"),r.b("\n"+s),r.b("<span class='glyphicon glyphicon-arrow-down tetrjs-arrow tetrjs-arrow-updown'></span>"),r.b("\n"+s),r.b("<span class='glyphicon glyphicon-arrow-right tetrjs-arrow tetrjs-arrow-leftright'></span>"),r.fl()},partials:{},subs:{}}),this.templates.paused=new Hogan.Template({code:function(t,e,s){var r=this;return r.b(s=s||""),r.b("Paused..."),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b('<button type="button"'),r.b("\n"+s),r.b('        id="tetrjs-pause-play"'),r.b("\n"+s),r.b('        class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-play"></span>&nbsp;&nbsp;Resume</button>'),r.b("\n"+s),r.b("<br/>"),r.b("\n"+s),r.b("<br/>Tip: Press <b>P</b> key to pause/resume."),r.fl()},partials:{},subs:{}});var Tetrjs=function(){this.board={},this.isPaused=!1,this.SETTINGS={BOARD_COLS_WIDE:10,BOARD_ROWS_HIGH:18,PIECE_START_COL:4,PIECE_START_ROW:1,PIECE_START_POS:1,GAME_INTERVAL_MS:460,GAME_SCORE_MULTIPLIER:100,CELL_WIDTH_PX:20,CELL_HEIGHT_PX:20},this.DOM_IDS={BOARD:"#tetrjs-board",PREVIEW_CONTAINER:"#tetrjs-next-piece-preview-container",SCORE_CONTAINER:"#tetrjs-score-container",LEVEL_CONTAINER:"#tetrjs-level-container",MODAL:"#tetrjs-modal",MODAL_VEIL:"#tetrjs-modal-veil"},this.DOM_CLASSES={BOARD_BLOCK:"tetrjs-board-block"},this.currentBlock={type:"",blockIds:[],blockPositions:[],class:"",row:this.SETTINGS.PIECE_START_ROW,col:this.SETTINGS.PIECE_START_COL,position:this.SETTINGS.PIECE_START_POS},this.previewPiece={type:"",class:"",blocks:[]},this.gameIntervalTimer={obj:!1,ms:this.SETTINGS.GAME_INTERVAL_MS},this.currentGame={score:0,rowsEliminated:0,level:1}};Tetrjs.prototype.setupBoard=function(){var t=$(this.DOM_IDS.BOARD);for(t.html(""),this.board={},t.width(this.SETTINGS.BOARD_COLS_WIDE*this.SETTINGS.CELL_WIDTH_PX),t.height(this.SETTINGS.BOARD_ROWS_HIGH*this.SETTINGS.CELL_HEIGHT_PX),i=1;i<=this.SETTINGS.BOARD_ROWS_HIGH;i++){this.board[i]={};var e=(i-1)*this.SETTINGS.CELL_HEIGHT_PX;for(j=1;j<=this.SETTINGS.BOARD_COLS_WIDE;j++){this.board[i][j]={};var s=(j-1)*this.SETTINGS.CELL_WIDTH_PX,r=" style='left:"+s+"px; top:"+e+"px;' ",n="<div class='"+this.DOM_CLASSES.BOARD_BLOCK+"' id='tb_"+j+"_"+i+"' "+r+"></div>";t.append(n)}}},Tetrjs.prototype.setupPreviewBoard=function(){var t=$(this.DOM_IDS.PREVIEW_CONTAINER);for(t.html(""),t.width(6*this.SETTINGS.CELL_WIDTH_PX),t.height(4*this.SETTINGS.CELL_HEIGHT_PX),i=1;i<=4;i++){var e=(i-1)*this.SETTINGS.CELL_HEIGHT_PX;for(j=1;j<=6;j++){var s=(j-1)*this.SETTINGS.CELL_WIDTH_PX,r=" style='left:"+s+"px; top:"+e+"px;' ",n="<div class='"+this.DOM_CLASSES.BOARD_BLOCK+"' id='tp_"+j+"_"+i+"' "+r+"></div>";t.append(n)}}},Tetrjs.prototype.generateRandomBlockType=function(){return BLOCK_TYPES[Math.floor(Math.random()*BLOCK_TYPES.length)]},Tetrjs.prototype.makePreviewBlock=function(){if(!this.isPaused){var t=this;$.each(this.previewPiece.blocks,function(e,s){$(s).removeClass(t.previewPiece.class)}),this.previewPiece.blocks=[],this.previewPiece.type=this.generateRandomBlockType(),this.previewPiece.class=BLOCKS[this.previewPiece.type].class;var e=BLOCKS[this.previewPiece.type].positions[0].rows;$.each(e,function(e,s){$.each(s,function(s,r){if(1==r){var n=2+parseInt(s),o=2+parseInt(e),i="#tp_"+n+"_"+o;$(i).addClass(t.previewPiece.class),t.previewPiece.blocks.push(i)}})})}},Tetrjs.prototype.moveBlock=function(t){var e=this,s=BLOCKS[this.currentBlock.type].no_positions,r=0,n=0,o=this.currentBlock.position;"up"==t&&(o=this.currentBlock.position+1,o>s-1&&(o=0),r=BLOCKS[this.currentBlock.type].positions[o].trans_row,n=BLOCKS[this.currentBlock.type].positions[o].trans_col);var i=[],a=!1,c=this.SETTINGS.BOARD_COLS_WIDE,l=this.SETTINGS.BOARD_ROWS_HIGH,b=!1,p=BLOCKS[this.currentBlock.type].positions[o].rows;if($.each(p,function(s,o){$.each(o,function(o,p){if(1==p){var h=e.currentBlock.col+parseInt(o),u=e.currentBlock.row+parseInt(s),_=h+n,d=u+r;"none"==t&&e.board[d][_].hasOwnProperty("class")&&e.gameOver(),"left"==t&&(_=h-1),"right"==t&&(_=h+1),"down"==t&&((d=u+1)>e.SETTINGS.BOARD_ROWS_HIGH||e.board[d][_].hasOwnProperty("class"))&&(a=!0),e.board.hasOwnProperty(d)&&e.board[d].hasOwnProperty(_)?e.board[d][_].hasOwnProperty("class")&&(b=!0):b=!0,b||(_<c&&(c=_),d<l&&(l=d),i.push({col:_,row:d}))}})}),!b&&!a){this.removeCurrentBlockFromBoard(),"up"==t&&(this.currentBlock.position=o),this.currentBlock.col=c,this.currentBlock.row=l;var e=this;$.each(i,function(t,s){var r="#tb_"+s.col+"_"+s.row;$(r).addClass(e.currentBlock.class),e.currentBlock.blockIds.push(r),e.currentBlock.blockPositions.push(s)})}if(a){var e=this;$.each(this.currentBlock.blockPositions,function(t,s){e.board[s.row][s.col]={class:e.currentBlock.class}}),this.checkAndEliminateRows(),this.nextBlock()}},Tetrjs.prototype.checkAndEliminateRows=function(){var t=0,e=this;$.each(this.board,function(s,r){var n=0;if($.each(r,function(t,e){e.hasOwnProperty("class")&&n++}),n==e.SETTINGS.BOARD_COLS_WIDE){t++;for(var o=s;o>=1;o--)$.each(e.board[o],function(t,s){var r="";e.board.hasOwnProperty(o-1)&&e.board[o-1][t].hasOwnProperty("class")&&(r=e.board[o-1][t].class);var n="#tb_"+t+"_"+o,i=$(n);s.hasOwnProperty("class")&&i.removeClass(s.class),""!=r?(i.addClass(r),e.board[o][t]={class:r}):e.board[o][t]={}})}}),t>0&&this.score(t)},Tetrjs.prototype.score=function(t){var e=0,s=this.SETTINGS.GAME_SCORE_MULTIPLIER*this.currentGame.level;this.currentGame.rowsEliminated=this.currentGame.rowsEliminated+t,t>1&&(e=t*(.5*s)),this.currentGame.score=this.currentGame.score+t*s+e,this.setScoreText(),this.currentGame.rowsEliminated==this.SETTINGS.BOARD_ROWS_HIGH&&(this.currentGame.rowsEliminated=0,this.currentGame.level=this.currentGame.level+1,this.setLevelText(),this.gameIntervalTimer.ms=this.gameIntervalTimer.ms-20)},Tetrjs.prototype.setScoreText=function(){$(this.DOM_IDS.SCORE_CONTAINER).text(this.currentGame.score)},Tetrjs.prototype.setLevelText=function(){$(this.DOM_IDS.LEVEL_CONTAINER).text("LEVEL "+this.currentGame.level)},Tetrjs.prototype.removeCurrentBlockFromBoard=function(){var t=this;$.each(this.currentBlock.blockIds,function(e,s){$(s).removeClass(t.currentBlock.class)}),this.currentBlock.blockIds=[],this.currentBlock.blockPositions=[]},Tetrjs.prototype.nextBlock=function(){this.isPaused||(this.currentBlock.blockIds=[],this.currentBlock.blockPositions=[],this.currentBlock.type=this.previewPiece.type,this.currentBlock.class=BLOCKS[this.currentBlock.type].class,this.currentBlock.row=1,this.currentBlock.col=this.SETTINGS.PIECE_START_COL,this.currentBlock.position=0,this.moveBlock("none"),this.killGameInterval(),this.startGameInterval(),this.makePreviewBlock())},Tetrjs.prototype.setupKeyEvents=function(){var t=this;$(document).keydown(function(e){switch(e.which){case 37:t.moveBlock("left");break;case 38:t.moveBlock("up");break;case 39:t.moveBlock("right");break;case 40:t.moveBlock("down");break;case 80:t.pauseGame();break;default:return}e.preventDefault()})},Tetrjs.prototype.startPlay=function(){this.isPaused=!1,""==this.previewPiece.type&&(this.previewPiece.type=this.generateRandomBlockType(),this.nextBlock()),this.startGameInterval(),this.hideMessage()},Tetrjs.prototype.startGameInterval=function(){if(!this.gameIntervalTimer.obj){var t=this;this.gameIntervalTimer.obj=setInterval(function(){t.moveBlock("down")},this.gameIntervalTimer.ms)}},Tetrjs.prototype.killGameInterval=function(){clearInterval(this.gameIntervalTimer.obj),this.gameIntervalTimer.obj=!1},Tetrjs.prototype.pauseGame=function(){var t=this;if(t.isPaused)return void t.startPlay();t.killGameInterval(),t.isPaused=!0,t.showMessage("paused"),$("button#tetrjs-pause-play").click(function(){t.startPlay()})},Tetrjs.prototype.gameOver=function(){var t=this;t.isPaused=!0,t.killGameInterval();var e={score:t.currentGame.score,rowsEliminated:t.currentGame.rowsEliminated,level:t.currentGame.level};t.showMessage("gameover",e),$("button#tetrjs-gameover-newgame").click(function(){t.newGame()})},Tetrjs.prototype.newGame=function(){this.killGameInterval(),this.currentGame.score=0,this.currentGame.level=1,this.gameIntervalTimer.ms=this.SETTINGS.GAME_INTERVAL_MS,this.setScoreText(),this.setLevelText(),this.setupBoard(),this.setupPreviewBoard(),this.previewPiece.type="",this.startPlay()},Tetrjs.prototype.showIntro=function(){var t=this;t.setupBoard(),t.setupPreviewBoard(),t.showMessage("intro"),$("button#tetrjs-intro-newgame").click(function(){t.newGame()})},Tetrjs.prototype.showAbout=function(){var t=this;t.killGameInterval(),t.isPaused=!0,t.showMessage("about"),$("button#tetrjs-about-close").click(function(){t.startPlay()})},Tetrjs.prototype.showMessage=function(t,e){var s=$(this.DOM_IDS.MODAL),r=$(this.DOM_IDS.MODAL_VEIL),n=templates[t].render(e);s.html(n);var o=Math.floor((r.width()-s.outerWidth())/2),i=Math.floor((r.height()-s.outerHeight())/2);s.css("left",o),s.css("top",i),r.fadeIn(200,function(){s.fadeIn(200)})},Tetrjs.prototype.hideMessage=function(){var t=$(this.DOM_IDS.MODAL),e=$(this.DOM_IDS.MODAL_VEIL);t.fadeOut(100,function(){e.hide(),t.html("")})},Tetrjs.prototype.run=function(t){var e=this;$("#"+t).html(templates.container.render()),$("button#tetrjs-container-pause").click(function(){e.pauseGame()}),$("button#tetrjs-container-new").click(function(){e.newGame()}),$("button#tetrjs-container-about").click(function(){e.showAbout()}),this.setupKeyEvents(),this.showIntro()};